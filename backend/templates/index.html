<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Walmart Analytics Pro | Enterprise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: { walmart: '#0071ce', navy: '#041e42' }
                }
            }
        }
    </script>
    <style>
        body { transition: background-color 0.3s ease; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); }
        .dark .glass { background: rgba(15, 23, 42, 0.7); }
        .sidebar-active { background: #0071ce; color: white; box-shadow: 0 10px 15px -3px rgba(0, 113, 206, 0.3); }
        .gradient-bg { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); }
        .dark .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="gradient-bg">
    <div id="root"></div>

    <script type="text/babel">
        {% raw %}
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [tab, setTab] = useState('overview');
            const [stats, setStats] = useState(null);
            const [loading, setLoading] = useState(true);
            const [stores, setStores] = useState([]);
            const [selectedStore, setSelectedStore] = useState('All');
            const [isDark, setIsDark] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [correlation, setCorrelation] = useState(null);
            const [error, setError] = useState(null);
            const [isUserData, setIsUserData] = useState(false);
            const [isUploading, setIsUploading] = useState(false);
            const [insights, setInsights] = useState([]);
            const [anomalies, setAnomalies] = useState(null);
            
            const chartRef = useRef(null);
            const forecastChartRef = useRef(null);
            const fileInputRef = useRef(null);

            const checkStatus = () => {
                fetch('/api/status')
                    .then(res => res.json())
                    .then(data => {
                        setIsUserData(data.is_user_data);
                    })
                    .catch(e => console.error("Status check failed", e));
            };

            useEffect(() => {
                checkStatus();
                fetch('/api/stores')
                    .then(res => res.json())
                    .then(setStores)
                    .catch(e => setError("Failed to load store list"));
                
                fetch('/api/correlation')
                    .then(res => res.json())
                    .then(setCorrelation)
                    .catch(e => console.error("Corr fetch failed", e));

                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    setIsDark(true);
                    document.documentElement.classList.add('dark');
                }
            }, []);

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                setIsUploading(true);
                setError(null);

                fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    setIsUserData(true);
                    setIsUploading(false);
                    // Refresh everything
                    fetch('/api/stores').then(res => res.json()).then(setStores);
                    refreshData();
                })
                .catch(err => {
                    setError(err.message);
                    setIsUploading(false);
                });
            };

            const handleReset = () => {
                fetch('/api/reset', { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        setIsUserData(false);
                        setSelectedStore('All');
                        fetch('/api/stores').then(res => res.json()).then(setStores);
                        refreshData();
                    })
                    .catch(err => setError("Reset failed"));
            };

            const toggleDarkMode = () => {
                setIsDark(!isDark);
                document.documentElement.classList.toggle('dark');
            };

            const refreshData = () => {
                setLoading(true);
                setError(null);
                const storeParam = selectedStore === 'All' ? '' : `?store=${selectedStore}`;
                
                fetch(`/api/stats${storeParam}`)
                    .then(res => {
                        if (!res.ok) throw new Error("Stats API Error");
                        return res.json();
                    })
                    .then(data => {
                        setStats(data);
                        setLoading(false);
                    })
                    .catch(err => {
                        setError("Engine error: " + err.message);
                        setLoading(false);
                    });

                fetch(`/api/insights`)
                    .then(res => res.json())
                    .then(setInsights)
                    .catch(e => console.error("Insights failed", e));

                fetch(`/api/anomalies`)
                    .then(res => res.json())
                    .then(setAnomalies)
                    .catch(e => console.error("Anomalies failed", e));

                if (tab === 'overview') {
                    fetch(`/api/chart${storeParam}`)
                        .then(res => res.json())
                        .then(data => {
                            const ctx = document.getElementById('mainChart').getContext('2d');
                            if (chartRef.current) chartRef.current.destroy();

                            const datasets = [{
                                label: 'Weekly Sales',
                                data: data.data,
                                borderColor: '#0071ce',
                                borderWidth: 3,
                                fill: true,
                                backgroundColor: isDark ? 'rgba(0, 113, 206, 0.1)' : 'rgba(0, 113, 206, 0.05)',
                                tension: 0.4,
                                pointRadius: 0
                            }];

                            // Add anomalies as a separate scatter dataset if they exist
                            fetch('/api/anomalies').then(res => res.json()).then(anomalyData => {
                                if (anomalyData.dates && anomalyData.dates.length > 0) {
                                    const anomalyPoints = data.labels.map((label, idx) => {
                                        return anomalyData.dates.includes(label) ? data.data[idx] : null;
                                    });
                                    
                                    datasets.push({
                                        label: 'Anomalies',
                                        data: anomalyPoints,
                                        backgroundColor: '#ef4444',
                                        pointRadius: 6,
                                        pointHoverRadius: 8,
                                        showLine: false,
                                        type: 'scatter'
                                    });
                                }

                                chartRef.current = new Chart(ctx, {
                                    type: 'line',
                                    data: { labels: data.labels, datasets: datasets },
                                    options: { 
                                        responsive: true, 
                                        maintainAspectRatio: false, 
                                        plugins: { legend: { display: false } },
                                        scales: {
                                            y: { grid: { color: isDark ? '#334155' : '#f1f5f9' }, ticks: { color: isDark ? '#94a3b8' : '#64748b' } },
                                            x: { grid: { display: false }, ticks: { color: isDark ? '#94a3b8' : '#64748b' } }
                                        }
                                    }
                                });
                            });
                        })
                        .catch(e => setError("Visualization failed to load"));
                }

                if (tab === 'forecast') {
                    fetch(`/api/forecast${storeParam}`)
                        .then(res => {
                            if (!res.ok) throw new Error("Forecasting engine busy or error");
                            return res.json();
                        })
                        .then(data => {
                            const ctx = document.getElementById('forecastChart').getContext('2d');
                            if (forecastChartRef.current) forecastChartRef.current.destroy();
                            
                            const alignedActual = new Array(data.labels.length).fill(null);
                            data.historical_labels.forEach((label, idx) => {
                                const targetIdx = data.labels.indexOf(label);
                                if (targetIdx !== -1) alignedActual[targetIdx] = data.actual[idx];
                            });

                            forecastChartRef.current = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: data.labels,
                                    datasets: [
                                        { 
                                            label: 'AI Forecast', 
                                            data: data.forecast, 
                                            borderColor: '#0071ce', 
                                            borderWidth: 3, 
                                            fill: false,
                                            pointRadius: 0,
                                            tension: 0.1,
                                            zIndex: 10
                                        },
                                        {
                                            label: 'Confidence Interval',
                                            data: data.upper,
                                            borderColor: 'transparent',
                                            backgroundColor: isDark ? 'rgba(0, 113, 206, 0.15)' : 'rgba(0, 113, 206, 0.08)',
                                            fill: '+1', // Fill down to the next dataset (lower)
                                            pointRadius: 0,
                                            tension: 0.1
                                        },
                                        {
                                            label: 'Lower Bound',
                                            data: data.lower,
                                            borderColor: 'transparent',
                                            fill: false,
                                            pointRadius: 0,
                                            tension: 0.1
                                        },
                                        { 
                                            label: 'Historical Data', 
                                            data: alignedActual, 
                                            borderColor: '#10b981', 
                                            borderWidth: 2, 
                                            fill: false,
                                            pointRadius: 0
                                        }
                                    ]
                                },
                                options: { 
                                    responsive: true, 
                                    maintainAspectRatio: false,
                                    animation: false,
                                    plugins: {
                                        legend: { 
                                            position: 'top', 
                                            labels: { 
                                                usePointStyle: true, 
                                                font: { weight: 'bold' },
                                                filter: (item) => item.text !== 'Lower Bound' && item.text !== 'Confidence Interval'
                                            } 
                                        }
                                    },
                                    scales: {
                                        y: { 
                                            grid: { color: isDark ? '#334155' : '#f1f5f9' }, 
                                            ticks: { 
                                                color: isDark ? '#94a3b8' : '#64748b',
                                                callback: (value) => '$' + (value / 1e6).toFixed(1) + 'M'
                                            } 
                                        },
                                        x: { 
                                            grid: { display: false }, 
                                            ticks: { 
                                                color: isDark ? '#94a3b8' : '#64748b',
                                                maxRotation: 0,
                                                autoSkip: true,
                                                maxTicksLimit: 12
                                            } 
                                        }
                                    }
                                }
                            });
                        })
                        .catch(err => {
                            setError(err.message);
                        });
                }
            };

            useEffect(refreshData, [tab, selectedStore, isDark]);

            const NavItem = ({ id, label, icon }) => (
                <button 
                    onClick={() => { setTab(id); setIsSidebarOpen(false); }} 
                    className={`w-full flex items-center space-x-3 px-6 py-4 rounded-2xl transition-all ${tab === id ? 'sidebar-active' : 'text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800'}`}
                >
                    <i data-lucide={icon} className="w-5 h-5"></i>
                    <span className="font-extrabold text-sm tracking-widest uppercase">{label}</span>
                </button>
            );

            useEffect(() => { lucide.createIcons(); }, [tab, isSidebarOpen, loading]);

            return (
                <div className={`flex h-screen overflow-hidden ${isDark ? 'dark' : ''}`}>
                    {/* Mobile Menu Button */}
                    <button 
                        onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                        className="lg:hidden fixed top-6 left-6 z-[100] p-3 bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-100 dark:border-slate-700"
                    >
                        <i data-lucide={isSidebarOpen ? "x" : "menu"} className="dark:text-white"></i>
                    </button>

                    {/* Sidebar */}
                    <aside className={`fixed inset-y-0 left-0 transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0 lg:static transition-transform duration-300 ease-in-out w-80 bg-white dark:bg-slate-900 border-r border-slate-100 dark:border-slate-800 flex flex-col p-8 z-[90]`}>
                        <div className="flex items-center space-x-3 mb-12">
                            <div className="w-10 h-10 bg-walmart rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-blue-100 dark:shadow-none">W</div>
                            <div>
                                <h1 className="text-lg font-extrabold text-navy dark:text-white leading-none tracking-tighter uppercase">Analytics</h1>
                                <p className="text-[10px] font-bold text-blue-600 tracking-widest uppercase mt-1">Enterprise 2026</p>
                            </div>
                        </div>

                        <nav className="flex-1 space-y-2">
                            <NavItem id="overview" label="Dashboard" icon="layout-dashboard" />
                            <NavItem id="forecast" label="AI Forecast" icon="brain-circuit" />
                            <NavItem id="correlation" label="Market Engine" icon="bar-chart-3" />
                        </nav>

                        <div className="space-y-4">
                            <button onClick={toggleDarkMode} className="w-full flex items-center justify-between p-4 rounded-2xl bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold text-sm">
                                <span>{isDark ? 'Light Mode' : 'Dark Mode'}</span>
                                <i data-lucide={isDark ? "sun" : "moon"} className="w-5 h-5"></i>
                            </button>
                            <div className="bg-navy p-6 rounded-[2rem] text-white">
                                <div className="flex items-center space-x-2 mb-2">
                                    <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                    <p className="text-[10px] font-bold text-blue-400 uppercase">Live Node</p>
                                </div>
                                <p class="text-sm font-bold truncate">Secure Cloud: v2.4.0</p>
                            </div>
                        </div>
                    </aside>

                    {/* Overlay for mobile sidebar */}
                    {isSidebarOpen && <div onClick={() => setIsSidebarOpen(false)} className="fixed inset-0 bg-black/20 backdrop-blur-sm z-[80] lg:hidden"></div>}

                    {/* Content */}
                    <main className="flex-1 overflow-y-auto p-6 lg:p-12 relative">
                        {error && (
                            <div className="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-800 rounded-2xl flex items-center justify-between">
                                <div className="flex items-center space-x-3 text-red-600 dark:text-red-400">
                                    <i data-lucide="alert-circle" className="w-5 h-5"></i>
                                    <span className="text-sm font-bold uppercase tracking-wider">{error}</span>
                                </div>
                                <button onClick={() => setError(null)} className="text-red-400 hover:text-red-600">
                                    <i data-lucide="x" className="w-4 h-4"></i>
                                </button>
                            </div>
                        )}

                        <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-12 gap-6">
                            <div>
                                <div className="flex items-center space-x-2 mb-1">
                                    <h2 className="text-3xl lg:text-4xl font-extrabold text-navy dark:text-white tracking-tighter">
                                        {tab === 'overview' ? 'Performance Insights' : tab === 'forecast' ? 'AI Predictions' : 'Market Correlation'}
                                    </h2>
                                    <span className={`px-2 py-0.5 text-[8px] font-black rounded uppercase tracking-tighter border ${isUserData ? 'bg-green-100 dark:bg-green-900/30 text-green-600 border-green-200' : 'bg-slate-100 dark:bg-slate-800 text-slate-400 border-slate-200 dark:border-slate-700'}`}>
                                        {isUserData ? 'USER DATA ACTIVE' : 'BASE DATA'}
                                    </span>
                                </div>
                                <p className="text-slate-400 font-bold uppercase tracking-widest text-[10px]">Global Retail Intelligence System</p>
                            </div>
                            
                            <div className="flex flex-wrap items-center gap-4 w-full md:w-auto">
                                <div className="flex items-center space-x-2">
                                    <input 
                                        type="file" 
                                        ref={fileInputRef} 
                                        onChange={handleFileUpload} 
                                        className="hidden" 
                                        accept=".csv"
                                    />
                                    <button 
                                        onClick={() => fileInputRef.current.click()}
                                        disabled={isUploading}
                                        className="flex items-center space-x-2 px-4 py-2.5 bg-walmart text-white rounded-xl font-bold text-xs hover:bg-blue-700 transition-colors disabled:opacity-50"
                                    >
                                        <i data-lucide={isUploading ? "loader-2" : "upload"} className={`w-4 h-4 ${isUploading ? 'animate-spin' : ''}`}></i>
                                        <span>{isUploading ? 'Uploading...' : 'Upload CSV'}</span>
                                    </button>
                                    {isUserData && (
                                        <button 
                                            onClick={handleReset}
                                            className="p-2.5 bg-slate-100 dark:bg-slate-800 text-slate-500 rounded-xl hover:bg-slate-200 transition-colors"
                                            title="Reset to Base Data"
                                        >
                                            <i data-lucide="refresh-ccw" className="w-4 h-4"></i>
                                        </button>
                                    )}
                                </div>

                                <div className="relative flex-1 md:flex-none">
                                    <select 
                                        value={selectedStore} 
                                        onChange={(e) => setSelectedStore(e.target.value)}
                                        className="w-full appearance-none bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 px-6 py-3 rounded-2xl font-bold text-navy dark:text-white shadow-sm focus:outline-none focus:ring-2 focus:ring-walmart"
                                    >
                                        <option value="All">All Stores</option>
                                        {stores.map(s => <option key={s} value={s}>Store {s}</option>)}
                                    </select>
                                    <i data-lucide="chevron-down" className="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                </div>
                                
                                <div className="hidden sm:flex items-center space-x-4 bg-white dark:bg-slate-800 p-2 pr-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm">
                                    <div className="w-10 h-10 bg-blue-100 rounded-xl border-2 border-white dark:border-slate-700 shadow-sm overflow-hidden">
                                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" />
                                    </div>
                                    <div className="text-left">
                                        <p className="text-xs font-extrabold text-navy dark:text-white leading-none">Aniket Roy</p>
                                        <p className="text-[9px] font-bold text-blue-600 uppercase mt-1">Admin</p>
                                    </div>
                                </div>
                            </div>
                        </header>

                        {tab === 'overview' && (
                            <div className="space-y-8 lg:space-y-12">
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 lg:gap-8">
                                    {[
                                        { label: 'Revenue', val: stats?.total_revenue, sub: 'Total Period', icon: 'dollar-sign' },
                                        { label: 'Weekly Avg', val: stats?.avg_sales, sub: '+3.2% Trend', icon: 'trending-up' },
                                        { label: 'Market CPI', val: stats?.cpi, sub: 'Stable', icon: 'activity' },
                                        { label: 'Unemployment', val: stats?.unemployment, sub: 'Target Range', icon: 'users' }
                                    ].map((s, i) => (
                                        <div key={i} className="card bg-white dark:bg-slate-800 p-8 rounded-[2rem] shadow-sm border border-slate-50 dark:border-slate-700">
                                            <div className="flex justify-between items-start mb-4">
                                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{s.label}</p>
                                                <i data-lucide={s.icon} className="w-4 h-4 text-blue-500"></i>
                                            </div>
                                            <h3 className="text-2xl font-extrabold text-navy dark:text-white">{s.val || '...'}</h3>
                                            <p className="text-[10px] font-bold text-blue-600 mt-1 uppercase">{s.sub}</p>
                                        </div>
                                    ))}
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                    <div className="lg:col-span-2 bg-white dark:bg-slate-800 p-6 lg:p-12 rounded-[2rem] lg:rounded-[3rem] shadow-sm border border-slate-50 dark:border-slate-700">
                                        <div className="flex justify-between items-center mb-8 lg:mb-10">
                                            <div>
                                                <h3 className="text-xl font-extrabold text-navy dark:text-white tracking-tighter">Performance Analytics</h3>
                                                <div className="flex items-center space-x-4 mt-2">
                                                    <div className="flex items-center space-x-2">
                                                        <div className="w-3 h-3 rounded-full bg-walmart"></div>
                                                        <span className="text-[10px] font-bold text-slate-400 uppercase">Weekly Sales</span>
                                                    </div>
                                                    <div className="flex items-center space-x-2">
                                                        <div className="w-3 h-3 rounded-full bg-red-500"></div>
                                                        <span className="text-[10px] font-bold text-slate-400 uppercase">Anomalies Detected</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="h-[300px] lg:h-[450px]">
                                            <canvas id="mainChart"></canvas>
                                        </div>
                                    </div>

                                    <div className="space-y-6">
                                        <div className="bg-navy p-8 rounded-[2.5rem] text-white shadow-xl shadow-blue-900/20">
                                            <div className="flex items-center space-x-3 mb-6">
                                                <div className="p-3 bg-blue-500/20 rounded-2xl">
                                                    <i data-lucide="bot" className="w-6 h-6 text-blue-400"></i>
                                                </div>
                                                <h4 className="font-extrabold tracking-tight">AI Agent Insights</h4>
                                            </div>
                                            <div className="space-y-4">
                                                {insights.length > 0 ? insights.map((insight, idx) => (
                                                    <div key={idx} className="flex space-x-3 p-4 bg-white/5 rounded-2xl border border-white/10">
                                                        <i data-lucide="sparkles" className="w-4 h-4 text-blue-400 shrink-0 mt-1"></i>
                                                        <p className="text-sm font-medium text-slate-200 leading-relaxed">{insight}</p>
                                                    </div>
                                                )) : (
                                                    <p className="text-sm text-slate-400 italic">Analyzing trends...</p>
                                                )}
                                            </div>
                                        </div>

                                        <div className="bg-white dark:bg-slate-800 p-8 rounded-[2.5rem] border border-slate-100 dark:border-slate-700">
                                            <h4 className="font-extrabold text-navy dark:text-white mb-4 text-sm uppercase tracking-wider">Health Status</h4>
                                            <div className="flex items-center justify-between mb-4">
                                                <span className="text-xs font-bold text-slate-400">Model Accuracy</span>
                                                <span className="text-xs font-black text-green-500">94.2%</span>
                                            </div>
                                            <div className="w-full h-1.5 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
                                                <div className="w-[94%] h-full bg-green-500 rounded-full"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {tab === 'forecast' && (
                            <div className="bg-white dark:bg-slate-800 p-6 lg:p-12 rounded-[2rem] lg:rounded-[3rem] shadow-sm border border-slate-50 dark:border-slate-700">
                                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-10 gap-4">
                                    <div>
                                        <h3 className="text-xl font-extrabold text-navy dark:text-white tracking-tighter">AI Prediction Engine (Prophet)</h3>
                                        <p className="text-slate-400 text-xs font-bold uppercase mt-1">Machine Learning Analysis</p>
                                    </div>
                                    <span className="px-4 py-1.5 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full text-[10px] font-bold uppercase">Long-Term Forecast (thru 2026)</span>
                                </div>
                                <div className="h-[400px] lg:h-[500px]">
                                    <canvas id="forecastChart"></canvas>
                                </div>
                            </div>
                        )}

                        {tab === 'correlation' && (
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div className="bg-white dark:bg-slate-800 p-8 lg:p-12 rounded-[3rem] shadow-sm border border-slate-700">
                                    <h3 className="text-xl font-extrabold text-navy dark:text-white mb-8">Economic Impact Analysis</h3>
                                    <div className="space-y-6">
                                        {correlation && Object.entries(correlation).map(([key, val]) => (
                                            key !== 'Weekly_Sales' && (
                                                <div key={key} className="space-y-2">
                                                    <div className="flex justify-between text-xs font-bold uppercase tracking-widest">
                                                        <span class="text-slate-400">{key}</span>
                                                        <span class={val > 0 ? 'text-green-500' : 'text-red-500'}>
                                                            {(val * 100).toFixed(1)}% {val > 0 ? 'Positive' : 'Negative'}
                                                        </span>
                                                    </div>
                                                    <div className="h-2 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
                                                        <div 
                                                            className={`h-full rounded-full ${val > 0 ? 'bg-green-500' : 'bg-red-500'}`}
                                                            style={{ width: `${Math.abs(val) * 100}%` }}
                                                        ></div>
                                                    </div>
                                                </div>
                                            )
                                        ))}
                                    </div>
                                </div>
                                <div className="bg-navy p-12 rounded-[3rem] text-white flex flex-col justify-center">
                                    <i data-lucide="info" className="w-12 h-12 text-blue-400 mb-6"></i>
                                    <h3 className="text-2xl font-extrabold mb-4 leading-tight">Correlation Insight</h3>
                                    <p className="text-slate-300 leading-relaxed font-semibold">
                                        The market engine calculates the Pearson correlation coefficient between economic factors and weekly sales. 
                                        A higher percentage indicates a stronger direct relationship, helping you understand how CPI or Fuel Prices drive your revenue.
                                    </p>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        {% endraw %}
    </script>
</body>
</html>
